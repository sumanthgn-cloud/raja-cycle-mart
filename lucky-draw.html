<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
  <link rel="canonical" href="https://raja-cycle-mart.vercel.app/lucky-draw.html" />
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DP7GDRXVQB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-DP7GDRXVQB');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Draw - Raja Cycle Mart</title>
    <meta name="description"
        content="Participate in Raja Cycle Mart's Monthly Lucky Draw! Enter your lucky code and stand a chance to win exciting prizes. Real-time updates!">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="images/favicon/light-theme-192.png" media="(prefers-color-scheme: light)" />
    <link rel="icon" type="image/png" href="images/favicon/favicon-96x96.png" media="(prefers-color-scheme: dark)" />
    <link rel="shortcut icon" href="images/favicon/favicon.ico" />

    <!-- Firebase SDK (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <!-- EmailJS SDK -->
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

    <style>
        /* Scoped Integration Styles */
        .lucky-app-wrapper {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 40px 20px;
        }

        .lucky-container {
            width: 100%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* App Header */
        .app-header {
            background: linear-gradient(135deg, #15803d 0%, #166534 100%);
            /* Green Theme */
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }

        .firebase-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .app-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .app-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Countdown Timer */
        .countdown-section {
            background: linear-gradient(45deg, #0f172a, #1e293b);
            /* Dark theme */
            color: white;
            padding: 20px;
            text-align: center;
            margin: 20px;
            border-radius: 12px;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        #countdown {
            font-size: 2.5em;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            color: #ffd700;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Stats Bar */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: #e5e7eb;
            /* Divider color */
            border-bottom: 1px solid #e5e7eb;
        }

        .stat-box {
            background: white;
            padding: 25px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 800;
            color: #15803d;
            /* Primary Green */
            line-height: 1;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Main Content Grid */
        .app-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            padding: 40px;
        }

        @media (max-width: 900px) {
            .app-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Forms & Sections */
        .panel-section {
            background: #fff;
        }

        .panel-title {
            color: #111827;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #22c55e;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95em;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s;
            background: #f9fafb;
        }

        .form-input:focus {
            outline: none;
            border-color: #22c55e;
            background: white;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        }

        /* OTP Styles */
        .otp-section {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #bae6fd;
            display: none;
        }

        .otp-section.visible {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .otp-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .verified-badge {
            background: #dcfce7;
            color: #166534;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            border: 1px solid #bbf7d0;
            margin-left: 10px;
        }

        .btn-submit {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            margin-top: 10px;
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-submit:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Live Entries */
        .entries-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        .entry-card {
            background: #fff;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            border: 1px solid #f3f4f6;
            border-left: 4px solid #3b82f6;
            /* Accent Blue */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.2s;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .entry-id {
            font-family: monospace;
            background: #eff6ff;
            color: #1d4ed8;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 700;
        }

        .entry-time {
            font-size: 0.8em;
            color: #9ca3af;
        }

        .status-msg {
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            font-weight: 500;
            display: none;
            animation: fadeIn 0.3s;
        }

        .admin-box {
            margin-top: 40px;
            padding: 30px;
            background: #fff8f8;
            border-top: 2px dashed #fca5a5;
            display: none;
            /* Hidden by default */
        }
    </style>
</head>

<body>
    <!-- Top Announcement Bar -->
    <div class="top-bar">
        <div class="container top-bar-inner">
            <div class="top-bar-offer">
                <i class="fas fa-bullhorn"></i>
                <span id="topBarOffer"></span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="site-header">
        <div class="nav-container">
            <div class="nav-left">
                <a href="index.html" class="brand" aria-label="Raja Cycle Mart - Home">
                    <img src="images/brand_design.png" alt="Raja Cycle Mart" class="brand-logo" />
                </a>
            </div>
            <nav class="nav-center" aria-label="Main navigation">
                <a href="index.html" class="nav-link">Home</a>
                <a href="marketplace.html" class="nav-link">Marketplace</a>
                <a href="lucky-draw.html" class="nav-link active">Lucky Draw 🎰</a>
                <a href="services.html" class="nav-link">Services</a>
                <a href="namma-yatri.html" class="nav-link">Namma Yatrigalu</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="blog/index.html" class="nav-link">Blog</a>
                <a href="contact.html" class="nav-link">Contact</a>
            </nav>
            <div class="nav-right">
                <a href="tel:+919844629722" class="btn btn-call">Call Now</a>
            </div>
        </div>
    </header>

    <!-- MAIN APP WRAPPER -->
    <div class="lucky-app-wrapper">
        <div class="lucky-container">

            <!-- App Header -->
            <div class="app-header">
                <div class="firebase-badge"><i class="fas fa-bolt"></i> Live System</div>
                <h1>Monthly Lucky Draw</h1>
                <p>Enter your unique Lucky Code below. Every purchase at Raja Cycle Mart qualifies you for a chance to
                    win Free Service & Accessories!</p>
            </div>

            <!-- Countdown Timer -->
            <div class="countdown-section">
                <h3 style="color:#e2e8f0; margin-bottom:5px; font-size:1rem; letter-spacing:1px;">⏳ DRAW CLOSES IN:</h3>
                <div id="countdown">00:00:00</div>
                <p style="color:#cbd5e1; font-size:0.9em;">Today at 7:00 PM | Winner announced immediately after</p>
            </div>

            <!-- Real-time Stats -->
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-number" id="totalEntries">0</div>
                    <div class="stat-label">Total Entries</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="todayEntries">0</div>
                    <div class="stat-label">Today's Entries</div>
                </div>
                <div class="stat-box" style="background:#f0fdf4;">
                    <div class="stat-number" style="font-size:1.5rem; margin-top:10px;" id="lastEntryID">--</div>
                    <div class="stat-label">Last Token ID</div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="app-content">

                <!-- Left: Entry Form -->
                <div class="panel-section">
                    <h2 class="panel-title"><i class="fas fa-ticket-alt" style="color:#22c55e;"></i> Submit Entry</h2>

                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" id="name" class="form-input" placeholder="Enter your full name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" id="phone" class="form-input" placeholder="10-digit mobile number"
                            pattern="[0-9]{10}" required>
                    </div>

                    <!-- Email & OTP Section -->
                    <div class="form-group">
                        <label class="form-label">Email Address * (For Verification)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="email" id="email" class="form-input" placeholder="your@email.com" required>
                            <button type="button" onclick="sendOTP()" id="sendOTPBtn" class="otp-btn">
                                📩 Send OTP
                            </button>
                        </div>
                        <div id="emailVerified" style="display:none; margin-top:8px;">
                            <span class="verified-badge"><i class="fas fa-check-circle"></i> Verified</span>
                        </div>
                    </div>

                    <!-- OTP Verification Input (Hidden initially) -->
                    <div id="otpSection" class="otp-section">
                        <label class="form-label" style="color:#0369a1;">Enter OTP Code</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="otpInput" class="form-input" placeholder="6-digit code" maxlength="6"
                                style="text-align:center; letter-spacing:2px; font-weight:bold;">
                            <button type="button" onclick="verifyOTP()" class="otp-btn" style="background:#22c55e;">
                                ? Verify
                            </button>
                        </div>
                        <p style="font-size:0.85em; color:#64748b; margin-top:8px;">
                            <i class="fas fa-info-circle"></i> OTP sent to: <span id="otpEmailDisplay"
                                style="font-weight:600;"></span>
                        </p>
                    </div>

                    <div class="form-group">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <div>
                                <label class="form-label">Lucky Code *</label>
                                <input type="text" id="luckyCode" class="form-input" placeholder="Code from bill"
                                    style="font-family:monospace; letter-spacing:1px; text-transform:uppercase;"
                                    required>
                            </div>
                            <div>
                                <label class="form-label">Bill No. *</label>
                                <input type="text" id="billNumber" class="form-input" placeholder="Invoice #" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Purchase Date</label>
                        <input type="date" id="purchaseDate" class="form-input" required>
                    </div>


                    <button class="btn-submit" onclick="submitEntry()" id="submitBtn" disabled>
                        📧 Verify Email First
                    </button>

                    <div id="statusMessage" class="status-msg"></div>

                    <p style="margin-top: 15px; font-size: 0.85em; color: #6b7280; text-align: center;">
                        <i class="fas fa-lock"></i> Your data is securely stored in Firebase Cloud Firestore.
                        Unique Token ID generated instantly.
                    </p>
                </div>

                <!-- Right: Live Feed -->
                <div class="panel-section">
                    <h2 class="panel-title"><i class="fas fa-stream" style="color:#3b82f6;"></i> Live Feed</h2>

                    <div class="entries-list" id="entriesList">
                        <div style="text-align:center; padding:40px; color:#999;">
                            <i class="fas fa-circle-notch fa-spin"></i> Connecting to Live Database...
                        </div>
                    </div>
                </div>

            </div>

            <!-- Admin Area (Hidden by Default) -->
            <div style="text-align: center; margin-top: 20px;">
                <a href="#" onclick="toggleAdminPanel(event)"
                    style="color: #9ca3af; font-size: 0.8em; text-decoration: none; border-bottom: 1px dotted #ccc;">
                    <i class="fas fa-wrench"></i> Staff Panel
                </a>
            </div>

            <div class="admin-box" id="adminPanel">
                <h3 style="color: #ef4444; margin-bottom:15px; font-size:1.1rem;"><i class="fas fa-user-shield"></i>
                    Admin Controls</h3>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn" onclick="selectRandomWinner()"
                        style="background: #374151; color: white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">
                        🎟️ Draw Winner
                    </button>
                    <button class="btn" onclick="exportToCSV()"
                        style="background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%); color: white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">
                        🎟️ Export CSV
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4 style="color: white;">Raja Cycle Mart</h4>
                    <p>Your trusted neighborhood cycle expert. Keeping Tumkur moving for over 3 decades.</p>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="services.html">Services</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Contact</h4>
                    <ul class="footer-links">
                        <li>+91 98446 29722</li>
                        <li>SS Puram, Tumkur</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <div>&copy; 2025 Raja Cycle Mart. All rights reserved.</div>
            </div>
        </div>
    </footer>

    <!-- Cookie Banner -->
    <div id="cookie-banner" class="cookie-banner">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center; width:100%;">
            <div class="cookie-text">
                <p style="margin:0; font-size:0.9rem; color:#555;">This website uses cookies for the best experience.
                </p>
            </div>
            <div class="cookie-actions">
                <button class="btn-cookie-accept" onclick="acceptAllCookies()"
                    style="background:#2E8B57; color:white; border:none; padding:8px 20px; border-radius:50px; cursor:pointer;">Accept</button>
            </div>
        </div>
    </div>

    <script src="site.js"></script>

    <!-- Firebase Logic -->
    <script>
        // ====================
        // CONFIGURATION
        // ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCeCsU4LTIQc6YmR7N67KSzAnNBpq-q0jA",
            authDomain: "raja-cycle-mart-1d02f.firebaseapp.com",
            projectId: "raja-cycle-mart-1d02f",
            storageBucket: "raja-cycle-mart-1d02f.firebasestorage.app",
            messagingSenderId: "1019709973668",
            appId: "1:1019709973668:web:b3ed2bc97c343d2f65f231",
            measurementId: "G-Z7HEMPQ0CE"
        };

        // EmailJS Config (Placeholders - USER MUST UPDATE)
        const EMAILJS_CONFIG = {
            USER_ID: "OsE88-Hsi7dIUcDaX",
            SERVICE_ID: "service_d7uro8b",
            TEMPLATE_ID: "template_6bakgu6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Initialize EmailJS
        (function () {
            // Only init if ID is not placeholder, else warn
            if (!EMAILJS_CONFIG.USER_ID.includes("YOUR_USER_ID")) {
                emailjs.init(EMAILJS_CONFIG.USER_ID);
                console.log("🎟️ EmailJS initialized");
            }
        })();

        console.log("🎟️ Firebase initialized successfully!");

        // ====================
        // GLOBAL STATE
        // ====================
        let generatedOTP = "";
        let isEmailVerified = false;

        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function generateLuckyDrawID() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');

            // Random 4-character string
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let random = '';
            for (let i = 0; i < 4; i++) {
                random += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            return `RC-${year}${month}${day}-${random}`;
        }

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.innerHTML = message;
            statusEl.style.display = 'block';

            if (type === 'success') {
                statusEl.style.background = '#dcfce7';
                statusEl.style.color = '#166534';
                statusEl.style.border = '1px solid #bbf7d0';
            } else {
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#991b1b';
                statusEl.style.border = '1px solid #fecaca';
            }

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // ====================
        // COUNTDOWN TIMER
        // ====================
        function updateCountdown() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const target = new Date(today);
            target.setHours(19, 0, 0, 0); // 7:00 PM today (19:00)

            if (now > target) {
                target.setDate(target.getDate() + 1);
            }

            const diff = target - now;

            if (diff <= 0) {
                document.getElementById('countdown').innerHTML = "🎟️ DRAW CLOSED!";
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('countdown').innerHTML =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        setInterval(updateCountdown, 1000);
        updateCountdown();

        // ====================
        // EMAIL OTP LOGIC
        // ====================
        async function sendOTP() {
            const email = document.getElementById('email').value.trim();
            const name = document.getElementById('name').value.trim();

            if (!email || !email.includes('@')) {
                showStatus("Please enter valid email address!", "error");
                return;
            }

            if (!name) {
                showStatus("Please enter your name first!", "error");
                return;
            }

            // Check configuration
            if (EMAILJS_CONFIG.USER_ID.includes("YOUR_USER_ID")) {
                // FALLBACK TEST MODE
                console.warn("🎟️ EmailJS not configured. Using Test Mode.");
                generatedOTP = "123456";
                document.getElementById('otpSection').classList.add('visible');
                document.getElementById('otpEmailDisplay').textContent = email;
                document.getElementById('sendOTPBtn').innerHTML = "🎟️ OTP Sent";
                document.getElementById('sendOTPBtn').disabled = true;

                showStatus(`<strong>TEST MODE:</strong> Your OTP is <b>${generatedOTP}</b>`, "success");
                return;
            }

            // Real Send
            generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
            const btn = document.getElementById('sendOTPBtn');
            btn.disabled = true;
            btn.innerHTML = "? Sending...";

            try {
                // NEW: Send via Secure Backend API (Absolute URL for cross-platform support)
                const response = await fetch('https://raja-cycle-mart.vercel.app/api/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to_email: email,
                        to_name: name,
                        otp: generatedOTP
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('otpSection').classList.add('visible');
                    document.getElementById('otpEmailDisplay').textContent = email;
                    btn.innerHTML = "🎟️ OTP Sent";
                    showStatus(`? OTP sent to ${email}. Check your inbox!`, "success");
                } else {
                    throw new Error(data.error || 'Server rejected email request');
                }

            } catch (error) {
                console.error("Email Backend Error:", error);

                // FALLBACK: Show OTP on screen if email fails
                alert(`🎟️ Email sending failed. Here is your OTP for now: ${generatedOTP}`);

                document.getElementById('otpSection').classList.add('visible');
                document.getElementById('otpEmailDisplay').textContent = email + " (Manual Mode)";
                btn.innerHTML = "🎟️ OTP Generated (Manual)";
            } finally {
                if (btn.disabled && btn.innerHTML === "? Sending...") {
                    btn.disabled = false;
                    btn.innerHTML = "🎟️ Try Again";
                }
            }
        }

        function verifyOTP() {
            const enteredOTP = document.getElementById('otpInput').value.trim();

            if (!enteredOTP || enteredOTP.length !== 6) {
                showStatus("Please enter a valid 6-digit OTP", "error");
                return;
            }

            if (enteredOTP === generatedOTP) {
                isEmailVerified = true;

                // UI Updates
                document.getElementById('emailVerified').style.display = 'block';
                document.getElementById('otpSection').classList.remove('visible');
                document.getElementById('email').disabled = true;
                document.getElementById('sendOTPBtn').style.display = 'none';

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> SUBMIT ENTRY';
                submitBtn.classList.add('active-submit'); // Add shine effect if desired

                showStatus("? Email verified successfully!", "success");
            } else {
                showStatus("? Invalid OTP code. Try again.", "error");
            }
        }

        // ====================
        // FORM SUBMISSION
        // ====================
        async function submitEntry() {
            if (!isEmailVerified) {
                showStatus('<i class="fas fa-lock"></i> Please verify your email first!', 'error');
                return;
            }

            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const luckyCode = document.getElementById('luckyCode').value.trim().toUpperCase();
            const billNumber = document.getElementById('billNumber').value.trim();
            const purchaseDate = document.getElementById('purchaseDate').value;
            const btn = document.getElementById('submitBtn');

            if (!name || !phone || !luckyCode || !billNumber || !purchaseDate) {
                showStatus('Please fill all required fields!', 'error');
                return;
            }

            if (phone.length !== 10 || !/^\d+$/.test(phone)) {
                showStatus('Please enter a valid 10-digit phone number!', 'error');
                return;
            }

            // Check for duplicate phone
            const duplicateCheck = await db.collection('lucky_entries')
                .where('phone', '==', phone)
                .get();

            if (!duplicateCheck.empty) {
                showStatus("🎟️ This phone number has already submitted an entry!", "error");
                return;
            }

            // Prevent double click
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';

            const luckyDrawID = generateLuckyDrawID();
            const timestamp = new Date().toISOString();

            try {
                await db.collection('lucky_entries').add({
                    luckyDrawID: luckyDrawID,
                    name: name,
                    phone: phone,
                    email: email,
                    luckyCode: luckyCode,
                    billNumber: billNumber,
                    purchaseDate: purchaseDate,
                    timestamp: timestamp,
                    status: 'verified',
                    verification: 'email_otp',
                    platform: 'web-v2',
                    ip: await getClientIP() // Optional
                });

                showStatus(`? <strong>Success!</strong> Account Created.<br>Token ID: <strong>${luckyDrawID}</strong>`);

                // Clear form
                document.getElementById('name').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('email').value = '';
                document.getElementById('luckyCode').value = '';
                document.getElementById('billNumber').value = '';

                // Reset State slightly or keep verified? 
                // Usually reset page state or reload
                setTimeout(() => window.location.reload(), 3000);

            } catch (error) {
                console.error('Firebase error:', error);
                showStatus(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> SUBMIT ENTRY';
            }
        }

        // ====================
        // REAL-TIME LISTENER
        // ====================
        function loadRealTimeEntries() {
            const entriesList = document.getElementById('entriesList');

            db.collection('lucky_entries')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .onSnapshot((snapshot) => {
                    entriesList.innerHTML = '';

                    if (snapshot.empty) {
                        entriesList.innerHTML = '<div style="text-align:center; padding:20px;">No entries yet today.</div>';
                        return;
                    }

                    const today = new Date().toDateString();
                    let lastEntryID = '--';

                    snapshot.forEach(doc => {
                        const data = doc.data();

                        if (lastEntryID === '--') lastEntryID = data.luckyDrawID;

                        const entryEl = document.createElement('div');
                        entryEl.className = 'entry-card';
                        entryEl.innerHTML = `
                            <div class="entry-header">
                                <span class="entry-id">🎟️ ${data.luckyDrawID}</span>
                                <span class="entry-time">${new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <div style="font-weight:600;">${data.name}</div>
                            <div style="font-size:0.9em; color:#555;">Code: ${data.luckyCode} – Bill: ${data.billNumber}</div>
                        `;
                        entriesList.appendChild(entryEl);
                    });

                    // Update Stats UI (Visual only)
                    document.getElementById('lastEntryID').textContent = lastEntryID;

                    // Real Stats (Separate Call)
                    updateRealCounts();

                }, (error) => {
                    entriesList.innerHTML = '<div style="color:red; p:20px;">Connection Error</div>';
                });
        }

        async function updateRealCounts() {
            try {
                const snap = await db.collection('lucky_entries').count().get();
                document.getElementById('totalEntries').textContent = snap.data().count;
            } catch (e) { console.log("Aggregation error", e); }
        }

        async function getClientIP() {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                return data.ip;
            } catch { return 'unknown'; }
        }

        // ====================
        // ADMIN Logic
        // ====================
        const ADMIN_PASSWORD = "RajaCycle2025";

        function toggleAdminPanel(e) {
            if (e) e.preventDefault();

            const panel = document.getElementById('adminPanel');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                return;
            }

            const code = prompt("🎟️ Enter Admin Password:");
            if (code === ADMIN_PASSWORD) {
                panel.style.display = 'block';
                showStatus('? Admin Mode Activated', 'success');
                panel.scrollIntoView({ behavior: "smooth" });
            } else {
                alert("? Access Denied");
            }
        }

        async function selectRandomWinner() {
            alert("[ADMIN] Winner selection logic would run here. (Check older comments for code)");
        }

        async function exportToCSV() {
            alert("[ADMIN] Export CSV logic would run here.");
        }

        // Init
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('purchaseDate').value = getTodayDate();
            loadRealTimeEntries();
        });
    </script>
</body>

</html>